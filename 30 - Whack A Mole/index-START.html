<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Whack A Mole!</title>
    <link href='https://fonts.googleapis.com/css?family=Amatic+SC:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <h1>Whack-a-mole! <span class="score">0</span></h1>
    <button onClick="startGame()">Start!</button>

    <div class="game">
        <div class="hole hole1">
            <div class="mole"></div>
        </div>
        <div class="hole hole2">
            <div class="mole"></div>
        </div>
        <div class="hole hole3">
            <div class="mole"></div>
        </div>
        <div class="hole hole4">
            <div class="mole"></div>
        </div>
        <div class="hole hole5">
            <div class="mole"></div>
        </div>
        <div class="hole hole6">
            <div class="mole"></div>
        </div>
    </div>

    <script>
        const scoreBoard = document.querySelector('.score');
        const moles = [...document.querySelectorAll('.mole')];
        let score = 0;
        let timeUp = true;
        let timer = null;
        const gameTime = 10;
        let timeLeft = gameTime;

        // init molesObj
        const molesObj = {};
        for (let i = 0; i < moles.length; i++) {
            molesObj[i] = false;
        }

        const molesProxy = new Proxy(molesObj, {
            get(target, key) {
                return target[key];
            },
            set(target, key, value) {
                target[key] = value;
                moles[key].removeEventListener('click', clickHandler);
                if (value) {
                    moles[key].classList.add('up');
                    moles[key].addEventListener('click', clickHandler);
                }
                else {
                    moles[key].classList.remove('up');
                }
            },
        });

        function startGame() {
            if (!timeUp) return;
            timeUp = false;
            setScore(0);
            showRandomMole();
            timer = setInterval(() => {
                timeLeft--;
                console.log(`timeLeft: ${timeLeft}`);
                if (!timeLeft) {
                    clearInterval(timer);
                    timeUp = true;
                    timeLeft = gameTime;
                    alert('Time\'s Up!');
                }
            }, 1000);
        }

        function setScore(value) {
            score = value;
            scoreBoard.textContent = score;
        }

        function showRandomMole() {
            let moleIndex = Math.floor(Math.random() * moles.length);
            let stayTime = Math.random() * (1500 - 1000) + 1000; // 1000~1500
            if (molesProxy[moleIndex]) return showRandomMole();
            setMole(moleIndex, stayTime);
        }

        function setMole(moleIndex, stayTime) {
            // show
            molesProxy[moleIndex] = true;
            
            // hide
            setTimeout(() => {
                molesProxy[moleIndex] = false;
            }, stayTime);

            setTimeout(() => {
                if (!timeUp) showRandomMole();
            }, stayTime / 2);
        }

        function clickHandler() {
            let moleIndex = moles.indexOf(event.currentTarget);
            molesProxy[moleIndex] = false;
            setScore(score + 1);
        }
    </script>
</body>

</html>